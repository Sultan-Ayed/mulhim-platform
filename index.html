<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ÙØ¬Ø± | Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ù†Ø¸Ù…Ø© Ù„ÙƒÙ„ Ø¨Ø§Ø­Ø«</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{--ink:#0f0e0d;--paper:#f5f0e8;--cream:#ede8de;--gold:#c9a84c;--gold-light:#e8cf8a;--teal:#1a6b6b;--teal-light:#2a9d8f;--muted:#7a7268;--border:#d4cebf;--white:#fdfcfa;--shadow:rgba(15,14,13,0.12);--red:#c0392b;--green:#27ae60}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Tajawal',sans-serif;background:var(--paper);color:var(--ink);min-height:100vh;direction:rtl}
body.en{direction:ltr}

/* HEADER */
header{background:var(--ink);padding:0 1.5rem;display:flex;align-items:center;justify-content:space-between;height:64px;position:sticky;top:0;z-index:200;border-bottom:3px solid var(--gold)}
.logo{display:flex;align-items:center;gap:.75rem}
.logo-icon{width:36px;height:36px;background:var(--gold);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0}
.logo-text{font-size:1.2rem;font-weight:800;color:var(--white)}
.logo-sub{font-size:.6rem;color:var(--gold-light);font-family:'IBM Plex Mono',monospace}
.header-controls{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap}
.btn-lang{background:transparent;border:1.5px solid var(--muted);color:var(--white);padding:.3rem .8rem;border-radius:4px;font-size:.78rem;cursor:pointer;transition:all .2s;font-family:'Tajawal',sans-serif}
.btn-lang:hover,.btn-lang.active{border-color:var(--gold);color:var(--gold)}
.style-select{background:transparent;border:1.5px solid var(--muted);color:var(--white);padding:.3rem .6rem;border-radius:4px;font-size:.78rem;cursor:pointer;outline:none;font-family:'Tajawal',monospace}
.style-select option{background:#1a1916;color:var(--white)}
.btn-header{background:transparent;border:1.5px solid var(--muted);color:var(--white);padding:.3rem .8rem;border-radius:4px;font-size:.78rem;cursor:pointer;transition:all .2s;font-family:'Tajawal',sans-serif;display:flex;align-items:center;gap:.3rem}
.btn-header:hover{border-color:var(--gold-light);color:var(--gold-light)}
.btn-header.save-pulse{border-color:var(--teal-light);color:var(--teal-light)}

/* LAYOUT */
.app-wrap{display:grid;grid-template-columns:260px 1fr 320px;min-height:calc(100vh - 64px)}

/* SIDEBAR */
.sidebar{background:var(--ink);padding:1.5rem 1rem;display:flex;flex-direction:column;gap:.4rem;overflow-y:auto}
.sidebar-label{font-size:.6rem;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;font-family:'IBM Plex Mono',monospace;margin-bottom:.4rem;padding-right:.4rem}
body.en .sidebar-label{padding-right:0;padding-left:.4rem}
.template-btn{background:transparent;border:1px solid #2a2925;color:#9a9082;padding:.8rem .9rem;border-radius:8px;text-align:right;cursor:pointer;transition:all .2s;font-family:'Tajawal',sans-serif;font-size:.85rem;line-height:1.4;position:relative;width:100%}
body.en .template-btn{text-align:left}
.template-btn .t-icon{font-size:.95rem;display:block;margin-bottom:.15rem}
.template-btn .t-name{display:block;font-weight:700;color:#ccc5b9;font-size:.88rem}
.template-btn .t-desc{display:block;font-size:.68rem;color:var(--muted);margin-top:.1rem}
.template-btn:hover{border-color:var(--gold);background:rgba(201,168,76,.07)}
.template-btn.active{border-color:var(--gold);background:rgba(201,168,76,.12)}
.template-btn.active .t-name{color:var(--gold)}
.template-btn.active::before{content:'';position:absolute;right:0;top:50%;transform:translateY(-50%);width:3px;height:60%;background:var(--gold);border-radius:3px 0 0 3px}
body.en .template-btn.active::before{right:auto;left:0;border-radius:0 3px 3px 0}
.sidebar-divider{border:none;border-top:1px solid #2a2925;margin:.75rem 0}
.sidebar-section-label{font-size:.58rem;color:#4a4540;text-transform:uppercase;letter-spacing:.1em;font-family:'IBM Plex Mono',monospace;margin-bottom:.35rem;padding-right:.4rem}

/* PROGRESS */
.progress-wrap{padding:.4rem}
.progress-label{display:flex;justify-content:space-between;font-size:.68rem;color:var(--muted);margin-bottom:.4rem;font-family:'IBM Plex Mono',monospace}
.progress-bar{height:4px;background:#2a2925;border-radius:2px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--teal-light),var(--gold));border-radius:2px;transition:width .5s ease;width:0%}

/* SAVED DRAFTS */
.drafts-list{display:flex;flex-direction:column;gap:.35rem;margin-top:.25rem}
.draft-item{background:#1a1916;border:1px solid #2a2925;border-radius:6px;padding:.6rem .75rem;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:space-between}
.draft-item:hover{border-color:var(--gold)}
.draft-name{font-size:.75rem;color:#ccc5b9;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:120px}
.draft-date{font-size:.6rem;color:var(--muted);font-family:'IBM Plex Mono',monospace}
.draft-del{background:transparent;border:none;color:#4a4540;cursor:pointer;font-size:.75rem;padding:.1rem .3rem;border-radius:3px;transition:color .2s}
.draft-del:hover{color:var(--red)}
.no-drafts{font-size:.72rem;color:#3a3830;text-align:center;padding:.75rem;font-style:italic}

/* QUALITY BADGE */
.quality-badge{display:inline-flex;align-items:center;gap:.4rem;padding:.4rem .8rem;border-radius:20px;font-size:.72rem;font-weight:700;margin-top:.5rem}
.quality-badge.low{background:rgba(192,57,43,.15);color:#e74c3c;border:1px solid rgba(192,57,43,.3)}
.quality-badge.mid{background:rgba(230,126,34,.15);color:#e67e22;border:1px solid rgba(230,126,34,.3)}
.quality-badge.high{background:rgba(39,174,96,.15);color:#27ae60;border:1px solid rgba(39,174,96,.3)}

/* FORM */
.form-area{padding:2rem 1.75rem;overflow-y:auto;background:var(--paper)}
.form-header{margin-bottom:1.75rem;padding-bottom:1.25rem;border-bottom:1px solid var(--border)}
.form-title-en{font-size:.65rem;color:var(--gold);font-family:'IBM Plex Mono',monospace;letter-spacing:.15em;text-transform:uppercase;margin-bottom:.3rem}
.form-title{font-size:1.6rem;font-weight:800;color:var(--ink);line-height:1.2}
.form-subtitle{color:var(--muted);font-size:.85rem;margin-top:.4rem;font-weight:300}

/* FIELD */
.field-section{background:var(--white);border:1px solid var(--border);border-radius:12px;margin-bottom:1.1rem;overflow:hidden;box-shadow:0 2px 8px var(--shadow);transition:box-shadow .2s}
.field-section:focus-within{box-shadow:0 4px 20px rgba(201,168,76,.15);border-color:var(--gold-light)}
.field-header{display:flex;align-items:center;justify-content:space-between;padding:.8rem 1.1rem;background:var(--cream);border-bottom:1px solid var(--border);gap:.75rem}
.field-label-wrap{display:flex;flex-direction:column;gap:.1rem;flex:1}
.field-label{font-size:.92rem;font-weight:700;color:var(--ink)}
.field-label-en{font-size:.65rem;color:var(--muted);font-family:'IBM Plex Mono',monospace}
.field-header-actions{display:flex;align-items:center;gap:.4rem}
.field-hint-btn{background:transparent;border:1px solid var(--border);border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:.7rem;color:var(--muted);transition:all .2s;flex-shrink:0}
.field-hint-btn:hover{background:var(--gold);border-color:var(--gold);color:var(--white)}
.word-counter{font-size:.62rem;color:var(--muted);font-family:'IBM Plex Mono',monospace;white-space:nowrap}
.word-counter.warn{color:#e67e22}
.word-counter.good{color:var(--green)}
.field-body{padding:1.1rem}
.field-hint-box{background:linear-gradient(135deg,#fffdf5,#fdf9ee);border:1px solid var(--gold-light);border-radius:8px;padding:.8rem .9rem;margin-bottom:.9rem;font-size:.78rem;color:#7a6830;line-height:1.7;display:none}
.field-hint-box.visible{display:block}

textarea,input[type=text],.field-select{width:100%;border:1.5px solid var(--border);border-radius:8px;padding:.7rem .9rem;font-family:'Tajawal',sans-serif;font-size:.9rem;color:var(--ink);background:var(--paper);outline:none;resize:vertical;transition:border-color .2s;direction:inherit}
textarea:focus,input[type=text]:focus,.field-select:focus{border-color:var(--teal-light);background:var(--white)}
textarea::placeholder,input::placeholder{color:#b0a99a}

/* QUESTIONS */
.questions-list{display:flex;flex-direction:column;gap:.55rem}
.question-item{display:flex;align-items:center;gap:.55rem}
.question-num{width:24px;height:24px;background:var(--ink);color:var(--gold);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:700;flex-shrink:0;font-family:'IBM Plex Mono',monospace}
.question-item input{margin:0}
.add-q-btn{background:transparent;border:1.5px dashed var(--border);border-radius:8px;padding:.45rem;width:100%;cursor:pointer;color:var(--muted);font-family:'Tajawal',sans-serif;font-size:.8rem;margin-top:.45rem;transition:all .2s}
.add-q-btn:hover{border-color:var(--teal-light);color:var(--teal)}

/* CITATION GENERATOR */
.cite-generator{background:var(--cream);border:1px solid var(--border);border-radius:10px;padding:1rem;margin-top:1rem}
.cite-gen-title{font-size:.78rem;font-weight:700;color:var(--ink);margin-bottom:.75rem;display:flex;align-items:center;gap:.4rem}
.cite-fields{display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin-bottom:.75rem}
.cite-field input{font-size:.78rem;padding:.45rem .7rem}
.cite-result{background:var(--white);border:1px solid var(--border);border-radius:6px;padding:.7rem .9rem;font-size:.78rem;color:var(--ink);min-height:40px;line-height:1.7;direction:ltr;text-align:left;font-family:'Georgia',serif}
.cite-actions{display:flex;gap:.5rem;margin-top:.5rem}
.btn-sm{padding:.35rem .8rem;border-radius:6px;font-size:.75rem;font-weight:600;cursor:pointer;font-family:'Tajawal',sans-serif;border:none;transition:all .2s}
.btn-sm.primary{background:var(--ink);color:var(--gold)}
.btn-sm.secondary{background:transparent;border:1px solid var(--border);color:var(--ink)}
.btn-sm:hover{opacity:.85}

/* QUALITY CHECKER */
.quality-panel{background:var(--white);border:1px solid var(--border);border-radius:12px;padding:1.25rem;margin-bottom:1.1rem}
.quality-title{font-size:.85rem;font-weight:700;margin-bottom:1rem;display:flex;align-items:center;gap:.4rem}
.quality-items{display:flex;flex-direction:column;gap:.5rem}
.quality-item{display:flex;align-items:center;gap:.6rem;font-size:.8rem}
.quality-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.quality-dot.ok{background:var(--green)}
.quality-dot.warn{background:#e67e22}
.quality-dot.bad{background:var(--red)}
.quality-score{font-size:1.8rem;font-weight:800;text-align:center;margin-bottom:.5rem}
.quality-score.low{color:var(--red)}
.quality-score.mid{color:#e67e22}
.quality-score.high{color:var(--green)}

/* METHODOLOGY HELPER */
.method-helper{background:var(--cream);border:1px solid var(--border);border-radius:10px;padding:1rem;margin-top:.75rem}
.method-q{font-size:.8rem;font-weight:600;margin-bottom:.5rem;color:var(--ink)}
.method-options{display:flex;flex-direction:column;gap:.35rem}
.method-opt{display:flex;align-items:flex-start;gap:.5rem;cursor:pointer;padding:.4rem .5rem;border-radius:6px;transition:background .15s}
.method-opt:hover{background:rgba(201,168,76,.08)}
.method-opt input{margin-top:2px;flex-shrink:0}
.method-opt-label{font-size:.78rem;color:var(--ink)}
.method-opt-desc{font-size:.68rem;color:var(--muted);margin-top:.1rem}
.method-result{margin-top:.75rem;padding:.7rem .9rem;background:var(--white);border:1px solid var(--gold-light);border-radius:8px;font-size:.78rem;color:#7a6830;line-height:1.7;display:none}
.method-result.visible{display:block}

/* EXPORT */
.export-wrap{margin-top:1.75rem;display:flex;gap:.75rem;flex-wrap:wrap;align-items:center}
.btn-export{display:flex;align-items:center;gap:.5rem;padding:.8rem 1.5rem;border-radius:8px;font-family:'Tajawal',sans-serif;font-size:.92rem;font-weight:700;cursor:pointer;transition:all .22s;border:none}
.btn-primary{background:var(--ink);color:var(--gold);box-shadow:0 4px 16px rgba(15,14,13,.3)}
.btn-primary:hover{transform:translateY(-2px)}
.btn-secondary{background:transparent;color:var(--ink);border:1.5px solid var(--border)}
.btn-secondary:hover{border-color:var(--ink)}
.btn-json{background:rgba(26,107,107,.12);color:var(--teal);border:1.5px solid rgba(26,107,107,.3)}
.btn-json:hover{background:rgba(26,107,107,.2)}
.autosave-indicator{display:flex;align-items:center;gap:.35rem;font-size:.7rem;color:var(--teal-light);font-family:'IBM Plex Mono',monospace;margin-top:.6rem}
.save-dot{width:6px;height:6px;border-radius:50%;background:var(--teal-light);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* PREVIEW */
.preview-panel{background:var(--white);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
body.en .preview-panel{border-right:none;border-left:1px solid var(--border)}
.preview-header{padding:.9rem 1.1rem;border-bottom:1px solid var(--border);background:var(--cream);display:flex;align-items:center;justify-content:space-between}
.preview-title{font-size:.65rem;font-family:'IBM Plex Mono',monospace;color:var(--muted);text-transform:uppercase;letter-spacing:.1em}
.preview-badge{background:var(--teal);color:var(--white);font-size:.58rem;padding:.18rem .45rem;border-radius:3px;font-family:'IBM Plex Mono',monospace}
.preview-doc{flex:1;overflow-y:auto;padding:1.75rem 1.25rem;font-family:'Georgia',serif;font-size:.8rem;line-height:1.9;color:#2a2520}
.doc-uni-header{text-align:center;border-bottom:2px solid var(--ink);padding-bottom:.9rem;margin-bottom:1.25rem}
.doc-uni-name{font-size:.82rem;font-weight:bold}
.doc-doc-type{font-size:.95rem;font-weight:bold;margin-top:.2rem}
.doc-style-tag{font-size:.62rem;color:var(--muted);font-family:'IBM Plex Mono',monospace;margin-top:.2rem}
.doc-section{margin-bottom:1.1rem}
.doc-section-title{font-size:.75rem;font-weight:bold;text-transform:uppercase;letter-spacing:.07em;border-bottom:1px solid var(--border);padding-bottom:.25rem;margin-bottom:.5rem;color:var(--ink)}
.doc-section-body{font-size:.78rem;color:#4a4540;line-height:1.8;white-space:pre-wrap;word-break:break-word}
.doc-placeholder{color:#c0bab0;font-style:italic;font-size:.75rem}

/* WELCOME */
.welcome-screen{grid-column:2/4;display:flex;align-items:center;justify-content:center;padding:3rem;text-align:center}
.welcome-inner{max-width:460px}
.welcome-icon{font-size:3.5rem;margin-bottom:1.25rem;display:block}
.welcome-title{font-size:1.8rem;font-weight:800;color:var(--ink);line-height:1.2;margin-bottom:.6rem}
.welcome-sub{color:var(--muted);font-size:.9rem;line-height:1.7;margin-bottom:1.75rem}
.welcome-arrow{display:inline-flex;align-items:center;gap:.5rem;font-size:.82rem;color:var(--gold);font-weight:600}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:500;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s}
.modal-overlay.open{opacity:1;pointer-events:all}
.modal{background:var(--white);border-radius:16px;padding:2rem;max-width:460px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.3);transform:translateY(20px);transition:transform .25s}
.modal-overlay.open .modal{transform:translateY(0)}
.modal-title{font-size:1.1rem;font-weight:800;margin-bottom:.5rem}
.modal-sub{font-size:.82rem;color:var(--muted);margin-bottom:1.25rem}
.modal input{width:100%;border:1.5px solid var(--border);border-radius:8px;padding:.7rem .9rem;font-family:'Tajawal',sans-serif;font-size:.9rem;outline:none;margin-bottom:1rem}
.modal input:focus{border-color:var(--teal-light)}
.modal-actions{display:flex;gap:.75rem;justify-content:flex-end}

/* TOAST */
.toast{position:fixed;bottom:2rem;left:50%;transform:translateX(-50%) translateY(80px);background:var(--ink);color:var(--gold);padding:.7rem 1.4rem;border-radius:8px;font-size:.85rem;font-family:'Tajawal',sans-serif;border:1px solid var(--gold);transition:transform .35s ease;z-index:999}
.toast.show{transform:translateX(-50%) translateY(0)}

@media(max-width:1100px){.app-wrap{grid-template-columns:240px 1fr}.preview-panel{display:none}}
@media(max-width:700px){.app-wrap{grid-template-columns:1fr}.sidebar{display:none}}
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">ğŸŒ…</div>
    <div>
      <div class="logo-text">ÙØ¬Ø±</div>
      <div class="logo-sub">ÙØ¬Ø±: Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ù†Ø¸Ù…Ø© Ù„ÙƒÙ„ Ø¨Ø§Ø­Ø«.</div>
    </div>
  </div>
  <div class="header-controls">
    <button class="btn-header" onclick="openSaveModal()">ğŸ’¾ <span id="hSave">Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©</span></button>
    <label class="btn-header" style="cursor:pointer">ğŸ“‚ <span id="hLoad">ØªØ­Ù…ÙŠÙ„ Ù…Ø³ÙˆØ¯Ø©</span><input type="file" accept=".json" id="importFile" style="display:none" onchange="importJSON(event)"></label>
    <select class="style-select" id="styleSelect" onchange="onStyleChange()">
      <option value="APA">APA 7th</option>
      <option value="MLA">MLA 9th</option>
      <option value="IEEE">IEEE</option>
      <option value="Chicago">Chicago</option>
    </select>
    <button class="btn-lang active" onclick="setLang('ar')" id="btnAr">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
    <button class="btn-lang" onclick="setLang('en')" id="btnEn">English</button>
  </div>
</header>

<div class="app-wrap">
  <aside class="sidebar">
    <div class="sidebar-label" id="sideLabel">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø§Ù„Ø¨</div>
    <button class="template-btn" onclick="selectTemplate('proposal')" id="tpl-proposal">
      <span class="t-icon">ğŸ“‹</span><span class="t-name" id="t1n">Ø§Ù„Ù…Ù‚ØªØ±Ø­ Ø§Ù„Ø¨Ø­Ø«ÙŠ</span><span class="t-desc" id="t1d">Research Proposal</span>
    </button>
    <button class="template-btn" onclick="selectTemplate('literature')" id="tpl-literature">
      <span class="t-icon">ğŸ“š</span><span class="t-name" id="t2n">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø¯Ø¨ÙŠØ§Øª</span><span class="t-desc" id="t2d">Literature Review</span>
    </button>
    <button class="template-btn" onclick="selectTemplate('thesis')" id="tpl-thesis">
      <span class="t-icon">ğŸ“</span><span class="t-name" id="t3n">Ø§Ù„Ø£Ø·Ø±ÙˆØ­Ø© Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©</span><span class="t-desc" id="t3d">Thesis / Dissertation</span>
    </button>
    <button class="template-btn" onclick="selectTemplate('paper')" id="tpl-paper">
      <span class="t-icon">ğŸ“„</span><span class="t-name" id="t4n">Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ø¨Ø­Ø«ÙŠØ©</span><span class="t-desc" id="t4d">Research Paper</span>
    </button>

    <hr class="sidebar-divider">
    <div class="progress-wrap">
      <div class="progress-label"><span id="progressLabel">Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</span><span id="progressPct">0%</span></div>
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
    </div>
    <div id="qualityWrap" style="padding:.4rem;display:none"></div>

    <hr class="sidebar-divider">
    <div class="sidebar-section-label" id="draftsLabel">Ø§Ù„Ù…Ø³ÙˆØ¯Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</div>
    <div class="drafts-list" id="draftsList"></div>
  </aside>

  <div id="mainContent">
    <div class="welcome-screen" id="welcomeScreen">
      <div class="welcome-inner">
        <span class="welcome-icon">ğŸŒ…</span>
        <h1 class="welcome-title" id="welcomeTitle">Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ Ø§Ù„Ø¨Ø­Ø«ÙŠØ©</h1>
        <p class="welcome-sub" id="welcomeSub">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„ØªØ¨Ø¯Ø£ ÙÙŠ ÙƒØªØ§Ø¨Ø© Ø¨Ø­Ø«Ùƒ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…Ù†Ø¸Ù…Ø© ÙˆØ§Ø­ØªØ±Ø§ÙÙŠØ©.</p>
        <div class="welcome-arrow" id="welcomeArrow">â† Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©</div>
      </div>
    </div>
    <div class="form-area" id="formArea" style="display:none">
      <div class="form-header">
        <div class="form-title-en" id="formTitleEn">RESEARCH PROPOSAL TEMPLATE</div>
        <h2 class="form-title" id="formTitle">Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ù‚ØªØ±Ø­ Ø§Ù„Ø¨Ø­Ø«ÙŠ</h2>
        <p class="form-subtitle" id="formSubtitle">Ø£ÙƒÙ…Ù„ Ø§Ù„Ø®Ø§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© ÙˆØ³ØªØ¸Ù‡Ø± Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¨Ø­Ø«Ùƒ ÙÙŠ Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠØ³Ø±</p>
      </div>
      <div id="fieldsContainer"></div>
      <div class="export-wrap">
        <button class="btn-export btn-primary" onclick="exportDoc()">â¬‡ <span id="exportBtn">ØªØµØ¯ÙŠØ± Word</span></button>
        <button class="btn-export btn-secondary" onclick="exportPDF()">ğŸ“„ <span id="exportPdfBtn">ØªØµØ¯ÙŠØ± PDF</span></button>
        <button class="btn-export btn-json" onclick="exportJSON()">ğŸ“¦ <span id="exportJsonBtn">Ø­ÙØ¸ JSON</span></button>
      </div>
      <div class="autosave-indicator"><div class="save-dot"></div><span id="autoSaveLabel">Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…ÙØ¹Ù‘Ù„</span></div>
    </div>
  </div>

  <aside class="preview-panel">
    <div class="preview-header">
      <span class="preview-title" id="previewLabel">Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø¨Ø§Ø´Ø±Ø©</span>
      <span class="preview-badge" id="styleTag">APA 7th</span>
    </div>
    <div class="preview-doc" id="previewDoc">
      <div id="previewEmpty" style="text-align:center;color:#c0bab0;padding:4rem 1rem;font-style:italic;font-size:.8rem">Ø§Ø®ØªØ± Ù‚Ø§Ù„Ø¨Ø§Ù‹ Ù„ØªØ±Ù‰ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‡Ù†Ø§...</div>
    </div>
  </aside>
</div>

<!-- SAVE MODAL -->
<div class="modal-overlay" id="saveModal">
  <div class="modal">
    <div class="modal-title" id="mTitle">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©</div>
    <div class="modal-sub" id="mSub">Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ø§Ù‹ Ù„Ù„Ù…Ø³ÙˆØ¯Ø© Ù„ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„ÙŠÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹</div>
    <input type="text" id="draftNameInput" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ - Ù…Ø³ÙˆØ¯Ø© 1">
    <div class="modal-actions">
      <button class="btn-sm secondary" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn-sm primary" onclick="saveDraft()">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<footer style="background:#0f0e0d;border-top:3px solid #c9a84c;padding:2.5rem 2rem;text-align:center;font-family:'Tajawal',sans-serif;">
  <div style="display:inline-block;border:1px solid #2a2925;border-radius:16px;padding:1.75rem 3rem;background:linear-gradient(135deg,#1a1916,#111);max-width:600px;width:100%;">
    <div style="font-size:1.4rem;margin-bottom:.5rem;color:#c9a84c;">ğŸŒ…</div>
    <div style="font-size:.62rem;color:#c9a84c;letter-spacing:.2em;text-transform:uppercase;font-family:'IBM Plex Mono',monospace;margin-bottom:.8rem;">Ø¥Ù‡Ù€Ø¯Ø§Ø¡</div>
    <p style="font-size:1rem;color:#e8e2d8;line-height:2;font-weight:400;margin:0;">
      Ø¥Ù„Ù‰ ÙƒÙ„ Ø¨Ø§Ø­Ø« ÙŠØ³Ø¹Ù‰ Ù„Ø¥Ø¶Ø§ÙØ© Ø­Ø±Ù ÙÙŠ ÙƒØªØ§Ø¨ Ø§Ù„Ù…Ø¹Ø±ÙØ©ØŒ<br>
      Ø¥Ù„Ù‰ ÙƒÙ„ Ù‚Ù„Ù… Ù„Ù… ÙŠØªÙˆÙ‚Ù Ø±ØºÙ… ØµØ¹ÙˆØ¨Ø© Ø§Ù„Ø·Ø±ÙŠÙ‚ØŒ<br>
      <span style="color:#c9a84c;font-weight:700;">Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„ÙƒÙ….</span>
    </p>
    <div style="margin-top:1.1rem;padding-top:1.1rem;border-top:1px solid #2a2925;font-size:.8rem;color:#7a7268;">
      Ø¨ÙƒÙ„ ØªÙ‚Ø¯ÙŠØ± ÙˆØ§Ø­ØªØ±Ø§Ù…ØŒ
      <span style="color:#c9a84c;font-weight:700;font-size:.95rem;display:block;margin-top:.25rem;">Ø³Ù„Ø·Ø§Ù† Ø¨Ù† Ø¹Ø§ÙŠØ¯</span>
    </div>
  </div>
  <div style="margin-top:1rem;font-size:.62rem;color:#3a3830;font-family:'IBM Plex Mono',monospace;">ÙØ¬Ø± Â© 2025 â€” Sultan-Ayed</div>
</footer>

<script>
var lang='ar', currentTemplate=null, formData={};

var T={
  ar:{sideLabel:'Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø§Ù„Ø¨',welcomeTitle:'Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ Ø§Ù„Ø¨Ø­Ø«ÙŠØ©',welcomeSub:'Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„ØªØ¨Ø¯Ø£ ÙÙŠ ÙƒØªØ§Ø¨Ø© Ø¨Ø­Ø«Ùƒ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…Ù†Ø¸Ù…Ø© ÙˆØ§Ø­ØªØ±Ø§ÙÙŠØ©.',welcomeArrow:'â† Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©',previewLabel:'Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø¨Ø§Ø´Ø±Ø©',progressLabel:'Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬',autoSaveLabel:'Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…ÙØ¹Ù‘Ù„',exportBtn:'ØªØµØ¯ÙŠØ± Word',exportPdfBtn:'ØªØµØ¯ÙŠØ± PDF',exportJsonBtn:'Ø­ÙØ¸ JSON',addQ:'+ Ø£Ø¶Ù Ø³Ø¤Ø§Ù„Ø§Ù‹',formSubtitle:'Ø£ÙƒÙ…Ù„ Ø§Ù„Ø®Ø§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© ÙˆØ³ØªØ¸Ù‡Ø± Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¨Ø­Ø«Ùƒ ÙÙŠ Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠØ³Ø±',previewEmpty:'Ø§Ø®ØªØ± Ù‚Ø§Ù„Ø¨Ø§Ù‹ Ù„ØªØ±Ù‰ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‡Ù†Ø§...',notEntered:'[ Ù„Ù… ÙŠÙØ¯Ø®ÙÙ„ Ø¨Ø¹Ø¯ ]',toastWord:'âœ” ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Word',toastPdf:'âœ” Ø¬Ø§Ø±ÙŠ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©',toastSaved:'âœ” ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©',toastLoaded:'âœ” ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©',toastDeleted:'âœ” ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ÙˆØ¯Ø©',toastCopied:'âœ” ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³',hSave:'Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©',hLoad:'ØªØ­Ù…ÙŠÙ„ Ù…Ø³ÙˆØ¯Ø©',draftsLabel:'Ø§Ù„Ù…Ø³ÙˆØ¯Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©',noDrafts:'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ÙˆØ¯Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©',mTitle:'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©',mSub:'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ø§Ù‹ Ù„Ù„Ù…Ø³ÙˆØ¯Ø© Ù„ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„ÙŠÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹',genCite:'ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³',copyCite:'Ù†Ø³Ø®',methodTitle:'Ù…Ø³Ø§Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ù‡Ø¬',methodQ:'Ø£Ø¬Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨',qualityTitle:'ØªÙ‚ÙŠÙŠÙ… Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¨Ø­Ø«',words:'ÙƒÙ„Ù…Ø©'},
  en:{sideLabel:'Choose Template',welcomeTitle:'Start Your Research Journey',welcomeSub:'Select a template type from the sidebar to begin writing your research in an organized, professional manner.',welcomeArrow:'Choose a template from the sidebar â†’',previewLabel:'Live Preview',progressLabel:'Form Completion',autoSaveLabel:'Auto-save enabled',exportBtn:'Export Word',exportPdfBtn:'Export PDF',exportJsonBtn:'Save JSON',addQ:'+ Add Question',formSubtitle:'Complete the fields below and your research preview will appear on the right.',previewEmpty:'Select a template to see the preview here...',notEntered:'[ Not yet entered ]',toastWord:'âœ” Word file created',toastPdf:'âœ” Opening print window',toastSaved:'âœ” Draft saved',toastLoaded:'âœ” Draft loaded',toastDeleted:'âœ” Draft deleted',toastCopied:'âœ” Citation copied',hSave:'Save Draft',hLoad:'Load Draft',draftsLabel:'Saved Drafts',noDrafts:'No saved drafts',mTitle:'ğŸ’¾ Save Draft',mSub:'Enter a name for your draft to return to it later',genCite:'Generate Citation',copyCite:'Copy',methodTitle:'Methodology Assistant',methodQ:'Answer questions to find the right approach',qualityTitle:'Research Quality Check',words:'words'}
};

var WORD_LIMITS={rtitle:15,abstract:300,intro:500,problem:300,objectives:200,methodology:200,findings:500,results:500,conclusion:200,scope:200,themes:400,gaps:200,references:0,keywords:0,questions:0};

var TEMPLATES={
  proposal:{
    ar:{title:'Ø§Ù„Ù…Ù‚ØªØ±Ø­ Ø§Ù„Ø¨Ø­Ø«ÙŠ',titleEn:'RESEARCH PROPOSAL TEMPLATE'},
    en:{title:'Research Proposal',titleEn:'RESEARCH PROPOSAL TEMPLATE'},
    fields:[
      {id:'rtitle',type:'text',ar:{label:'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¨Ø­Ø«',hint:'ØµØº Ø¹Ù†ÙˆØ§Ù†Ø§Ù‹ ÙˆØ§Ø¶Ø­Ø§Ù‹ ÙˆÙ…Ø­Ø¯Ø¯Ø§Ù‹ ÙŠØ¹ÙƒØ³ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø©. ÙŠÙØ¶Ù„ Ø£Ù„Ø§ ÙŠØªØ¬Ø§ÙˆØ² 15 ÙƒÙ„Ù…Ø©.'},en:{label:'Research Title',hint:'Write a clear title reflecting the research problem. Ideally no more than 15 words.'},ph:{ar:'Ù…Ø«Ø§Ù„: Ø£Ø«Ø± Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø¹Ù„Ù‰ Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ...',en:'e.g., The Impact of AI Tools on Academic Achievement...'}},
      {id:'problem',type:'textarea',ar:{label:'Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø©',hint:'Ø§Ø¨Ø¯Ø£ Ø¨ÙˆØµÙ Ø§Ù„Ø¸Ø§Ù‡Ø±Ø©ØŒ Ø«Ù… Ø¨ÙŠÙ† Ø§Ù„ÙØ¬ÙˆØ© Ø§Ù„Ù…Ø¹Ø±ÙÙŠØ©ØŒ ÙˆØ§Ø®ØªÙ… Ø¨ØµÙŠØ§ØºØ© Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ÙƒØ³Ø¤Ø§Ù„ Ù…Ø­ÙˆØ±ÙŠ.'},en:{label:'Problem Statement',hint:'Describe the phenomenon, identify the knowledge gap, then frame the problem as a central question.'},ph:{ar:'ØªØ¹Ø¯ Ø¸Ø§Ù‡Ø±Ø©... Ù…Ù† Ø£Ø¨Ø±Ø² Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª Ø§Ù„ØªÙŠ ØªÙˆØ§Ø¬Ù‡...',en:'The phenomenon of... represents one of the most pressing challenges in...'}},
      {id:'questions',type:'questions',ar:{label:'Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø©',hint:'ØµØº ÙƒÙ„ Ø³Ø¤Ø§Ù„ Ø¨Ø¯Ø¡Ø§Ù‹ Ø¨Ù€ Ù…Ø§ØŒ ÙƒÙŠÙØŒ Ù‡Ù„. ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù‚ÙŠØ§Ø³.'},en:{label:'Research Questions',hint:'Frame each question starting with What, How, Does. Questions must be measurable.'},ph:{ar:'Ø£Ø¯Ø®Ù„ Ø³Ø¤Ø§Ù„Ø§Ù‹ Ø¨Ø­Ø«ÙŠØ§Ù‹...',en:'Enter a research question...'}},
      {id:'objectives',type:'textarea',ar:{label:'Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ø¯Ø±Ø§Ø³Ø©',hint:'Ø§Ø³ØªØ®Ø¯Ù… Ø£ÙØ¹Ø§Ù„ Ø¥Ø¬Ø±Ø§Ø¦ÙŠØ©: ÙŠØ­Ø¯Ø¯ØŒ ÙŠÙ‚ÙŠØ³ØŒ ÙŠÙ‚Ø§Ø±Ù†ØŒ ÙŠØ­Ù„Ù„ØŒ ÙŠØ®ØªØ¨Ø±.'},en:{label:'Study Objectives',hint:'Use action verbs: identify, measure, compare, analyze, test.'},ph:{ar:'1. Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰...\n2. Ù‚ÙŠØ§Ø³ Ù…Ø³ØªÙˆÙ‰...\n3. Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨ÙŠÙ†...',en:'1. To identify...\n2. To measure...\n3. To compare...'}},
      {id:'methodology',type:'method',ar:{label:'Ù…Ù†Ù‡Ø¬ÙŠØ© Ø§Ù„Ø¯Ø±Ø§Ø³Ø©',hint:'Ø­Ø¯Ø¯ Ø§Ù„Ù…Ù†Ù‡Ø¬ ÙˆØ§Ù„Ø£Ø¯ÙˆØ§Øª ÙˆØ§Ù„Ø¹ÙŠÙ†Ø©. Ø¨Ø±Ø± Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ø¨ÙŠØ¹Ø© Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø©.'},en:{label:'Methodology',hint:'Specify the approach, instruments, and sample. Justify your choice.'},
        options:{ar:['Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„ÙƒÙ…ÙŠ','Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„Ù†ÙˆØ¹ÙŠ','Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„Ù…Ø®ØªÙ„Ø·','Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ','Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„ÙˆØµÙÙŠ'],en:['Quantitative','Qualitative','Mixed Methods','Experimental','Descriptive']}},
      {id:'references',type:'references',ar:{label:'Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ ÙˆØ§Ù„Ù…ØµØ§Ø¯Ø±',hint:'Ø£Ø¯Ø®Ù„ Ù…Ø±Ø§Ø¬Ø¹Ùƒ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ù…ÙˆÙ„Ø¯ Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³Ø§Øª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø§Ù„Ø£Ø³ÙÙ„.'},en:{label:'References',hint:'Enter your references or use the citation generator below.'},ph:{ar:'Ø§Ù„Ø­Ø±Ø¨ÙŠØŒ Ø®Ø§Ù„Ø¯. (2022). Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØªØ§Ø¨. Ø¯Ø§Ø± Ø§Ù„Ù†Ø´Ø±.',en:'Smith, J. (2021). Title of Work. Publisher.'}}
    ]
  },
  literature:{
    ar:{title:'Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø¯Ø¨ÙŠØ§Øª',titleEn:'LITERATURE REVIEW TEMPLATE'},
    en:{title:'Literature Review',titleEn:'LITERATURE REVIEW TEMPLATE'},
    fields:[
      {id:'rtitle',type:'text',ar:{label:'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',hint:'Ø­Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ ÙˆØ§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø²Ù…Ù†ÙŠ.'},en:{label:'Review Title',hint:'Define the topic and time scope.'},ph:{ar:'Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ù†Ù‡Ø¬ÙŠØ© Ù„Ø¯Ø±Ø§Ø³Ø§Øª...',en:'A Systematic Review of...'}},
      {id:'scope',type:'textarea',ar:{label:'Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆÙ‡Ø¯ÙÙ‡Ø§',hint:'ÙˆØ¶Ø­ Ø§Ù„Ù‡Ø¯Ù ÙˆØ§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© ÙˆØ§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ ÙˆØ§Ù„Ø²Ù…Ù†ÙŠ.'},en:{label:'Scope and Purpose',hint:'Clarify the purpose, target population, and scope.'},ph:{ar:'ØªÙ‡Ø¯Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¥Ù„Ù‰ ØªØ¬Ù…ÙŠØ¹ ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„ØªÙŠ ØªÙ†Ø§ÙˆÙ„Øª...',en:'This review aims to synthesize and analyze studies that examined...'}},
      {id:'themes',type:'textarea',ar:{label:'Ø§Ù„Ù…Ø­Ø§ÙˆØ± ÙˆØ§Ù„Ù…ÙˆØ¶ÙˆØ¹Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',hint:'ØµÙ†Ù Ø§Ù„Ø£Ø¯Ø¨ÙŠØ§Øª Ø¶Ù…Ù† Ù…Ø­Ø§ÙˆØ± Ù…ÙˆØ¶ÙˆØ¹ÙŠØ© ÙˆØ§Ø°ÙƒØ± Ø§Ù„Ø§ØªÙØ§Ù‚Ø§Øª ÙˆØ§Ù„Ø§Ø®ØªÙ„Ø§ÙØ§Øª.'},en:{label:'Main Themes',hint:'Categorize literature into thematic groups.'},ph:{ar:'Ø§Ù„Ù…Ø­ÙˆØ± Ø§Ù„Ø£ÙˆÙ„: ...\nØ§Ù„Ù…Ø­ÙˆØ± Ø§Ù„Ø«Ø§Ù†ÙŠ: ...',en:'Theme 1: ...\nTheme 2: ...'}},
      {id:'gaps',type:'textarea',ar:{label:'Ø§Ù„ÙØ¬ÙˆØ§Øª Ø§Ù„Ø¨Ø­Ø«ÙŠØ©',hint:'Ù‡Ø°Ø§ Ø£Ù‡Ù… Ø¬Ø²Ø¡. Ø­Ø¯Ø¯ Ù…Ø§ Ù„Ù… ØªØ¯Ø±Ø³Ù‡ Ø§Ù„Ø£Ø¨Ø­Ø§Ø« Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©.'},en:{label:'Research Gaps',hint:'Identify what prior research has not addressed.'},ph:{ar:'Ø±ØºÙ… ØªØ¹Ø¯Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³Ø§ØªØŒ Ø¥Ù„Ø§ Ø£Ù†Ù‡Ø§ Ø£ØºÙÙ„Øª...',en:'Despite extensive research, existing studies have neglected...'}},
      {id:'references',type:'references',ar:{label:'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹',hint:'Ø±ØªØ¨ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ Ø£Ø¨Ø¬Ø¯ÙŠØ§Ù‹ Ø­Ø³Ø¨ Ù†Ù…Ø· Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ù…Ø®ØªØ§Ø±.'},en:{label:'References',hint:'Arrange references alphabetically.'},ph:{ar:'Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ Ù‡Ù†Ø§...',en:'Enter references here...'}}
    ]
  },
  thesis:{
    ar:{title:'Ø§Ù„Ø£Ø·Ø±ÙˆØ­Ø© Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©',titleEn:'THESIS / DISSERTATION TEMPLATE'},
    en:{title:'Thesis / Dissertation',titleEn:'THESIS / DISSERTATION TEMPLATE'},
    fields:[
      {id:'rtitle',type:'text',ar:{label:'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø£Ø·Ø±ÙˆØ­Ø©',hint:'ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø´Ø§Ù…Ù„Ø§Ù‹ ÙˆØ¯Ù‚ÙŠÙ‚Ø§Ù‹ ÙˆÙŠØ¹ÙƒØ³ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£Ø·Ø±ÙˆØ­Ø©.'},en:{label:'Thesis Title',hint:'The title must be comprehensive and precise.'},ph:{ar:'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø£Ø·Ø±ÙˆØ­Ø©...',en:'Thesis title...'}},
      {id:'abstract',type:'textarea',ar:{label:'Ø§Ù„Ù…Ù„Ø®Øµ',hint:'200-350 ÙƒÙ„Ù…Ø© ØªØ´Ù…Ù„: Ø§Ù„Ù…Ø´ÙƒÙ„Ø©ØŒ Ø§Ù„Ù…Ù†Ù‡Ø¬ÙŠØ©ØŒ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ØŒ Ø§Ù„ØªÙˆØµÙŠØ§Øª.'},en:{label:'Abstract',hint:'200-350 words covering: problem, methodology, findings, recommendations.'},ph:{ar:'ØªØªÙ†Ø§ÙˆÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ù…Ø´ÙƒÙ„Ø©... Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù†Ù‡Ø¬...',en:'This study examines the problem of... using a... methodology.'}},
      {id:'intro',type:'textarea',ar:{label:'Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©',hint:'Ø§Ø¨Ø¯Ø£ Ø¨Ø¹Ø§Ù… Ø«Ù… Ø¶ÙŠÙ‚ Ù†Ø­Ùˆ Ø§Ù„Ø®Ø§Øµ. ØªØ¶Ù…Ù†: Ø§Ù„Ø³ÙŠØ§Ù‚ØŒ Ø§Ù„Ø£Ù‡Ù…ÙŠØ©ØŒ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©ØŒ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù.'},en:{label:'Chapter 1: Introduction',hint:'Begin broadly then narrow to the specific. Include: context, significance, problem, objectives.'},ph:{ar:'ÙŠØ´Ù‡Ø¯ Ø§Ù„Ø¹Ø§Ù„Ù… ØªØ­ÙˆÙ„Ø§Øª Ù…ØªØ³Ø§Ø±Ø¹Ø© ÙÙŠ Ù…Ø¬Ø§Ù„...',en:'The world is witnessing rapid transformations in...'}},
      {id:'methodology',type:'method',ar:{label:'Ù…Ù†Ù‡Ø¬ÙŠØ© Ø§Ù„Ø¨Ø­Ø«',hint:'Ø§Ø´Ø±Ø­ Ø¨Ø§Ù„ØªÙØµÙŠÙ„: Ø§Ù„Ù…Ù†Ù‡Ø¬ØŒ Ø§Ù„Ø¹ÙŠÙ†Ø©ØŒ Ø§Ù„Ø£Ø¯ÙˆØ§ØªØŒ Ø§Ù„Ø£Ø³Ø§Ù„ÙŠØ¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©.'},en:{label:'Research Methodology',hint:'Describe: approach, sample, instruments, statistical methods.'},options:{ar:['Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„ÙƒÙ…ÙŠ','Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„Ù†ÙˆØ¹ÙŠ','Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„Ù…Ø®ØªÙ„Ø·','Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ','Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„ÙˆØµÙÙŠ'],en:['Quantitative','Qualitative','Mixed Methods','Experimental','Descriptive']}},
      {id:'findings',type:'textarea',ar:{label:'Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„',hint:'Ø§Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨ØªØ±ØªÙŠØ¨ Ù…Ù†Ø·Ù‚ÙŠ ÙŠØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø©.'},en:{label:'Findings and Analysis',hint:'Present findings in a logical order aligned with research questions.'},ph:{ar:'Ø£Ø¸Ù‡Ø±Øª Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø£Ù†...',en:'The findings of the study revealed that...'}},
      {id:'references',type:'references',ar:{label:'Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹',hint:'Ø£Ø¯Ø®Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©.'},en:{label:'References',hint:'Enter all references used.'},ph:{ar:'Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹...',en:'References...'}}
    ]
  },
  paper:{
    ar:{title:'Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ø¨Ø­Ø«ÙŠØ©',titleEn:'RESEARCH PAPER TEMPLATE'},
    en:{title:'Research Paper',titleEn:'RESEARCH PAPER TEMPLATE'},
    fields:[
      {id:'rtitle',type:'text',ar:{label:'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ±Ù‚Ø©',hint:'Ø¹Ù†ÙˆØ§Ù† Ù‚ØµÙŠØ± Ù„Ø§ ÙŠØªØ¬Ø§ÙˆØ² 12 ÙƒÙ„Ù…Ø© ÙŠØ­Ù…Ù„ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ©.'},en:{label:'Paper Title',hint:'A concise title not exceeding 12 words with keywords.'},ph:{ar:'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ø¨Ø­Ø«ÙŠØ©...',en:'Paper title...'}},
      {id:'abstract',type:'textarea',ar:{label:'Ø§Ù„Ù…Ù„Ø®Øµ',hint:'150-250 ÙƒÙ„Ù…Ø©: Ø§Ù„Ù‡Ø¯ÙØŒ Ø§Ù„Ù…Ù†Ù‡Ø¬ØŒ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ØŒ Ø§Ù„Ø§Ø³ØªÙ†ØªØ§Ø¬.'},en:{label:'Abstract',hint:'150-250 words: Purpose, Methodology, Findings, Conclusion.'},ph:{ar:'Ø§Ù„Ù‡Ø¯Ù: ...\nØ§Ù„Ù…Ù†Ù‡Ø¬: ...\nØ§Ù„Ù†ØªØ§Ø¦Ø¬: ...',en:'Purpose: ...\nMethodology: ...\nFindings: ...'}},
      {id:'keywords',type:'text',ar:{label:'Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ©',hint:'5-7 ÙƒÙ„Ù…Ø§Øª Ù…ÙØªØ§Ø­ÙŠØ© Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©.'},en:{label:'Keywords',hint:'5-7 keywords separated by commas.'},ph:{ar:'Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ØŒ Ø§Ù„Ø«Ø§Ù†ÙŠØ©ØŒ Ø§Ù„Ø«Ø§Ù„Ø«Ø©...',en:'keyword one, keyword two...'}},
      {id:'intro',type:'textarea',ar:{label:'Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©',hint:'Ø³ÙŠØ§Ù‚ Ø§Ù„Ø¯Ø±Ø§Ø³Ø©ØŒ Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…ÙˆØ¬Ø²Ø© Ù„Ù„Ø£Ø¯Ø¨ÙŠØ§ØªØŒ Ø§Ù„ÙØ¬ÙˆØ© Ø§Ù„Ø¨Ø­Ø«ÙŠØ©ØŒ Ù‡Ø¯Ù Ø§Ù„ÙˆØ±Ù‚Ø©.'},en:{label:'Introduction',hint:'Study context, brief literature overview, research gap, aim.'},ph:{ar:'ØªØ¹Ø¯ Ù‚Ø¶ÙŠØ©... Ù…Ù† Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§ Ø§Ù„Ù…Ø­ÙˆØ±ÙŠØ© ÙÙŠ Ù…Ø¬Ø§Ù„...',en:'The issue of... represents a central concern in...'}},
      {id:'results',type:'textarea',ar:{label:'Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„Ù…Ù†Ø§Ù‚Ø´Ø©',hint:'Ù†Ø§Ù‚Ø´ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙÙŠ Ø¶ÙˆØ¡ Ø§Ù„Ø£Ø¯Ø¨ÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©.'},en:{label:'Results and Discussion',hint:'Discuss findings in light of prior literature.'},ph:{ar:'Ø£Ø³ÙØ±Øª Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¹Ù†...',en:'The analysis yielded...'}},
      {id:'conclusion',type:'textarea',ar:{label:'Ø§Ù„Ø®Ø§ØªÙ…Ø© ÙˆØ§Ù„ØªÙˆØµÙŠØ§Øª',hint:'Ù„Ø®Øµ Ø£Ø¨Ø±Ø² Ø§Ù„Ù†ØªØ§Ø¦Ø¬ØŒ Ø§Ø°ÙƒØ± Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯ÙŠØ©ØŒ Ù‚Ø¯Ù… ØªÙˆØµÙŠØ§Øª Ù„Ù„Ø¨Ø§Ø­Ø«ÙŠÙ† Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙŠÙ†.'},en:{label:'Conclusion and Recommendations',hint:'Summarize findings, acknowledge limitations, recommend for future research.'},ph:{ar:'Ø®Ù„ØµØª Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø¥Ù„Ù‰...',en:'The study concluded that...'}},
      {id:'references',type:'references',ar:{label:'Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹',hint:'Ø±ØªØ¨ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ ÙˆÙÙ‚ Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ù…Ø®ØªØ§Ø±.'},en:{label:'References',hint:'Arrange references per selected style.'},ph:{ar:'Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹...',en:'References...'}}
    ]
  }
};

var TEMPLATE_META={
  proposal:{ar:{name:'Ø§Ù„Ù…Ù‚ØªØ±Ø­ Ø§Ù„Ø¨Ø­Ø«ÙŠ',desc:'Research Proposal'},en:{name:'Research Proposal',desc:'Ø®Ø·Ø· Ø§Ù„Ø£Ø¨Ø­Ø§Ø«'}},
  literature:{ar:{name:'Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø¯Ø¨ÙŠØ§Øª',desc:'Literature Review'},en:{name:'Literature Review',desc:'Ù†Ù‚Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª'}},
  thesis:{ar:{name:'Ø§Ù„Ø£Ø·Ø±ÙˆØ­Ø© Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©',desc:'Thesis / Dissertation'},en:{name:'Thesis / Dissertation',desc:'Ø£Ø¹Ù…Ø§Ù„ Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©'}},
  paper:{ar:{name:'Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ø¨Ø­Ø«ÙŠØ©',desc:'Research Paper'},en:{name:'Research Paper',desc:'Ù„Ù„Ù†Ø´Ø± ÙÙŠ Ø§Ù„Ù…Ø¬Ù„Ø§Øª'}}
};

/* â”€â”€ LANG â”€â”€ */
function setLang(l){
  lang=l;
  document.documentElement.lang=l;
  document.body.classList.toggle('en',l==='en');
  document.body.dir=l==='ar'?'rtl':'ltr';
  document.getElementById('btnAr').classList.toggle('active',l==='ar');
  document.getElementById('btnEn').classList.toggle('active',l==='en');
  var t=T[l];
  ['sideLabel','welcomeTitle','welcomeSub','welcomeArrow','previewLabel','progressLabel','autoSaveLabel',
   'exportBtn','exportPdfBtn','exportJsonBtn','hSave','hLoad','draftsLabel'].forEach(function(id){
    var el=document.getElementById(id); if(el) el.textContent=t[id]||'';
  });
  document.getElementById('previewEmpty').textContent=t.previewEmpty;
  document.getElementById('mTitle').textContent=t.mTitle;
  document.getElementById('mSub').textContent=t.mSub;
  Object.keys(TEMPLATE_META).forEach(function(k){
    var m=TEMPLATE_META[k][l];
    document.querySelector('#tpl-'+k+' .t-name').textContent=m.name;
    document.querySelector('#tpl-'+k+' .t-desc').textContent=m.desc;
  });
  renderDraftsList();
  if(currentTemplate) selectTemplate(currentTemplate);
}

/* â”€â”€ TEMPLATE â”€â”€ */
function selectTemplate(id){
  currentTemplate=id;
  if(!formData[id]) formData[id]={};
  document.querySelectorAll('.template-btn').forEach(function(b){b.classList.remove('active');});
  document.getElementById('tpl-'+id).classList.add('active');
  document.getElementById('welcomeScreen').style.display='none';
  document.getElementById('formArea').style.display='block';
  var tpl=TEMPLATES[id];
  var info=tpl[lang]||tpl['ar'];
  document.getElementById('formTitleEn').textContent=tpl.ar.titleEn;
  document.getElementById('formTitle').textContent=info.title;
  document.getElementById('formSubtitle').textContent=T[lang].formSubtitle;
  renderFields(id,tpl.fields);
  updatePreview(id);
  updateProgress(id);
  autoSave();
}

/* â”€â”€ RENDER FIELDS â”€â”€ */
function renderFields(templateId,fields){
  var container=document.getElementById('fieldsContainer');
  container.innerHTML='';
  fields.forEach(function(f){
    var saved=formData[templateId][f.id]||'';
    var info=f[lang]||f['ar'];
    var ph=(f.ph&&(f.ph[lang]||f.ph['ar']))||'';
    var otherInfo=(f[lang==='ar'?'en':'ar'])||{};
    var section=document.createElement('div');
    section.className='field-section';
    var wl=WORD_LIMITS[f.id]||0;
    var wcHTML=wl>0?'<span class="word-counter" id="wc-'+templateId+'-'+f.id+'">0 / '+wl+' '+T[lang].words+'</span>':'';
    var hintId='hint-'+templateId+'-'+f.id;
    section.innerHTML='<div class="field-header">'
      +'<div class="field-label-wrap"><span class="field-label">'+escHtml(info.label)+'</span>'
      +'<span class="field-label-en">'+escHtml(otherInfo.label||'')+'</span></div>'
      +'<div class="field-header-actions">'+wcHTML
      +'<button class="field-hint-btn" id="hbtn-'+hintId+'">?</button></div></div>'
      +'<div class="field-body"><div class="field-hint-box" id="'+hintId+'">'+escHtml(info.hint||'')+'</div>'
      +renderInput(f,templateId,saved,ph)+'</div>';
    container.appendChild(section);
    document.getElementById('hbtn-'+hintId).addEventListener('click',function(){toggleHint(hintId);});
    attachInputEvents(f,templateId,ph);
    if(wl>0) updateWordCount(templateId,f.id,saved);
  });
}

function renderInput(f,templateId,saved,ph){
  if(f.type==='text'){
    return '<input type="text" id="field-'+templateId+'-'+f.id+'" placeholder="'+escAttr(ph)+'" value="'+escAttr(saved)+'">';
  }
  if(f.type==='textarea'){
    return '<textarea id="field-'+templateId+'-'+f.id+'" rows="5" placeholder="'+escAttr(ph)+'">'+escHtml(saved)+'</textarea>';
  }
  if(f.type==='method'){
    var opts=(f.options&&(f.options[lang]||f.options['ar']))||[];
    var selOpts=opts.map(function(o){return '<option value="'+escAttr(o)+'"'+(saved===o?' selected':'')+'>'+escHtml(o)+'</option>';}).join('');
    return '<select class="field-select" id="field-'+templateId+'-'+f.id+'">'+'<option value="">-- Ø§Ø®ØªØ± --</option>'+selOpts+'</select>'
      +renderMethodHelper(templateId,f.id);
  }
  if(f.type==='questions'){
    return '<div class="questions-list" id="qlist-'+templateId+'-'+f.id+'"></div>'
      +'<button class="add-q-btn" id="addq-'+templateId+'-'+f.id+'">'+T[lang].addQ+'</button>';
  }
  if(f.type==='references'){
    return '<textarea id="field-'+templateId+'-'+f.id+'" rows="4" placeholder="'+escAttr(ph)+'" style="direction:ltr;text-align:left;font-family:Georgia,serif;font-size:.8rem">'+escHtml(saved)+'</textarea>'
      +renderCiteGenerator(templateId,f.id);
  }
  return '';
}

function renderMethodHelper(templateId,fieldId){
  var t=T[lang];
  return '<div class="method-helper"><div class="method-q">ğŸ§­ '+t.methodTitle+'</div>'
    +'<div class="method-options">'
    +'<label class="method-opt"><input type="radio" name="mq-'+templateId+'-'+fieldId+'" value="numbers" onchange="calcMethod(\''+templateId+'\',\''+fieldId+'\')"><div><div class="method-opt-label">'+(lang==='ar'?'Ø¨ÙŠØ§Ù†Ø§ØªÙŠ Ø£Ø±Ù‚Ø§Ù… ÙˆØ¥Ø­ØµØ§Ø¡Ø§Øª':'My data is numbers and statistics')+'</div></div></label>'
    +'<label class="method-opt"><input type="radio" name="mq-'+templateId+'-'+fieldId+'" value="experience" onchange="calcMethod(\''+templateId+'\',\''+fieldId+'\')"><div><div class="method-opt-label">'+(lang==='ar'?'Ø£Ø¯Ø±Ø³ ØªØ¬Ø§Ø±Ø¨ ÙˆØ¢Ø±Ø§Ø¡ Ø§Ù„Ù†Ø§Ø³':'I study people\'s experiences and opinions')+'</div></div></label>'
    +'<label class="method-opt"><input type="radio" name="mq-'+templateId+'-'+fieldId+'" value="both" onchange="calcMethod(\''+templateId+'\',\''+fieldId+'\')"><div><div class="method-opt-label">'+(lang==='ar'?'ÙƒÙ„Ø§Ù‡Ù…Ø§ Ù…Ø¹Ø§Ù‹':'Both together')+'</div></div></label>'
    +'<label class="method-opt"><input type="radio" name="mq-'+templateId+'-'+fieldId+'" value="experiment" onchange="calcMethod(\''+templateId+'\',\''+fieldId+'\')"><div><div class="method-opt-label">'+(lang==='ar'?'Ø£Ø¬Ø±ÙŠ ØªØ¬Ø±Ø¨Ø© ÙˆØ£Ù‚ÙŠØ³ Ù†ØªØ§Ø¦Ø¬Ù‡Ø§':'I run an experiment and measure results')+'</div></div></label>'
    +'</div>'
    +'<div class="method-result" id="mres-'+templateId+'-'+fieldId+'"></div>'
    +'</div>';
}

function calcMethod(templateId,fieldId){
  var radios=document.querySelectorAll('input[name="mq-'+templateId+'-'+fieldId+'"]');
  var val='';
  radios.forEach(function(r){if(r.checked) val=r.value;});
  var res=document.getElementById('mres-'+templateId+'-'+fieldId);
  if(!res) return;
  var msgs={
    numbers:{ar:'âœ… Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„ÙƒÙ…ÙŠ Ù‡Ùˆ Ø§Ù„Ø£Ù†Ø³Ø¨ Ù„Ùƒ. ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¡ Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙØ±Ø¶ÙŠØ§Øª.',en:'âœ… Quantitative approach is best for you. It relies on numbers and statistics to test hypotheses.'},
    experience:{ar:'âœ… Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„Ù†ÙˆØ¹ÙŠ Ù‡Ùˆ Ø§Ù„Ø£Ù†Ø³Ø¨ Ù„Ùƒ. ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù…Ù‚ Ù„Ù„ØªØ¬Ø§Ø±Ø¨ ÙˆØ§Ù„Ù…Ø¹Ø§Ù†ÙŠ.',en:'âœ… Qualitative approach is best for you. It relies on in-depth analysis of experiences and meanings.'},
    both:{ar:'âœ… Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„Ù…Ø®ØªÙ„Ø· Ù‡Ùˆ Ø§Ù„Ø£Ù†Ø³Ø¨. ÙŠØ¬Ù…Ø¹ Ø¨ÙŠÙ† Ø§Ù„ÙƒÙ…ÙŠ ÙˆØ§Ù„Ù†ÙˆØ¹ÙŠ Ù„Ù†ØªØ§Ø¦Ø¬ Ø£Ø´Ù…Ù„.',en:'âœ… Mixed methods is best for you. It combines quantitative and qualitative for comprehensive results.'},
    experiment:{ar:'âœ… Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ Ù‡Ùˆ Ø§Ù„Ø£Ù†Ø³Ø¨. ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆÙ‚ÙŠØ§Ø³ Ø§Ù„Ù†ØªØ§Ø¦Ø¬.',en:'âœ… Experimental design is best for you. It relies on controlling variables and measuring outcomes.'}
  };
  res.textContent=(msgs[val]&&msgs[val][lang])||'';
  res.classList.toggle('visible',!!val);
}

function renderCiteGenerator(templateId,fieldId){
  var t=T[lang];
  return '<div class="cite-generator">'
    +'<div class="cite-gen-title">ğŸ“– Ù…ÙˆÙ„Ù‘Ø¯ Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³Ø§Øª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</div>'
    +'<div class="cite-fields">'
    +'<input type="text" placeholder="'+(lang==='ar'?'Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ù„Ù':'Author Name')+'" id="cAuthor-'+templateId+'-'+fieldId+'" class="cite-field">'
    +'<input type="text" placeholder="'+(lang==='ar'?'Ø§Ù„Ø³Ù†Ø©':'Year')+'" id="cYear-'+templateId+'-'+fieldId+'" class="cite-field">'
    +'<input type="text" placeholder="'+(lang==='ar'?'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…Ù„':'Title of Work')+'" id="cTitle-'+templateId+'-'+fieldId+'" class="cite-field">'
    +'<input type="text" placeholder="'+(lang==='ar'?'Ø§Ù„Ù†Ø§Ø´Ø± / Ø§Ù„Ù…Ø¬Ù„Ø©':'Publisher / Journal')+'" id="cPublisher-'+templateId+'-'+fieldId+'" class="cite-field">'
    +'</div>'
    +'<div class="cite-result" id="cResult-'+templateId+'-'+fieldId+'">'+( lang==='ar'?'Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³ Ù‡Ù†Ø§...':'Citation will appear here...')+'</div>'
    +'<div class="cite-actions">'
    +'<button class="btn-sm primary" onclick="generateCite(\''+templateId+'\',\''+fieldId+'\')">'+t.genCite+'</button>'
    +'<button class="btn-sm secondary" onclick="copyCite(\''+templateId+'\',\''+fieldId+'\')">'+t.copyCite+'</button>'
    +'</div></div>';
}

function generateCite(templateId,fieldId){
  var author=document.getElementById('cAuthor-'+templateId+'-'+fieldId).value.trim();
  var year=document.getElementById('cYear-'+templateId+'-'+fieldId).value.trim();
  var title=document.getElementById('cTitle-'+templateId+'-'+fieldId).value.trim();
  var publisher=document.getElementById('cPublisher-'+templateId+'-'+fieldId).value.trim();
  if(!author&&!title){document.getElementById('cResult-'+templateId+'-'+fieldId).textContent=lang==='ar'?'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¤Ù„Ù ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„':'Please enter at least author and title';return;}
  var style=document.getElementById('styleSelect').value;
  var cite='';
  if(style==='APA'){
    cite=author+(year?' ('+year+').':'.') +(title?' '+title+'.':'')+(publisher?' '+publisher+'.':'');
  } else if(style==='MLA'){
    cite=author+(title?' "'+title+'."':'')+(publisher?' '+publisher+',':'')+(year?' '+year+'.':'');
  } else if(style==='IEEE'){
    cite=author+(title?', "'+title+'"':'')+(publisher?', '+publisher:'')+(year?', '+year:'')+(title?'.':'');
  } else {
    cite=author+(year?' ('+year+').':'.') +(title?' "'+title+'."':'')+(publisher?' '+publisher+'.':'');
  }
  document.getElementById('cResult-'+templateId+'-'+fieldId).textContent=cite;
}

function copyCite(templateId,fieldId){
  var txt=document.getElementById('cResult-'+templateId+'-'+fieldId).textContent;
  if(navigator.clipboard){navigator.clipboard.writeText(txt);}
  showToast(T[lang].toastCopied);
}

function attachInputEvents(f,templateId,ph){
  if(f.type==='text'||f.type==='textarea'||f.type==='references'){
    var el=document.getElementById('field-'+templateId+'-'+f.id);
    if(el){
      el.addEventListener('input',function(){
        formData[templateId][f.id]=el.value;
        updatePreview(templateId);updateProgress(templateId);
        if(WORD_LIMITS[f.id]>0) updateWordCount(templateId,f.id,el.value);
        autoSave();
      });
    }
  } else if(f.type==='method'){
    var sel=document.getElementById('field-'+templateId+'-'+f.id);
    if(sel){sel.addEventListener('change',function(){formData[templateId][f.id]=sel.value;updatePreview(templateId);updateProgress(templateId);autoSave();});}
  } else if(f.type==='questions'){
    var savedQs=formData[templateId][f.id+'_list']||[''];
    renderQuestions(templateId,f.id,savedQs,ph);
    var addBtn=document.getElementById('addq-'+templateId+'-'+f.id);
    if(addBtn){addBtn.addEventListener('click',function(){
      var list=formData[templateId][f.id+'_list']||[''];
      list.push('');renderQuestions(templateId,f.id,list,ph);
    });}
  }
}

function updateWordCount(templateId,fieldId,val){
  var wc=document.getElementById('wc-'+templateId+'-'+fieldId);
  if(!wc) return;
  var words=val.trim()?val.trim().split(/\s+/).length:0;
  var limit=WORD_LIMITS[fieldId]||0;
  wc.textContent=words+' / '+limit+' '+T[lang].words;
  wc.className='word-counter'+(words>limit?' warn':words>=limit*0.7?' good':'');
}

function renderQuestions(templateId,fieldId,savedQs,ph){
  var container=document.getElementById('qlist-'+templateId+'-'+fieldId);
  if(!container) return;
  container.innerHTML='';
  formData[templateId][fieldId+'_list']=savedQs;
  savedQs.forEach(function(q,i){
    var item=document.createElement('div');item.className='question-item';
    var num=document.createElement('div');num.className='question-num';num.textContent=i+1;
    var inp=document.createElement('input');inp.type='text';inp.placeholder=ph;inp.value=q;
    (function(idx){inp.addEventListener('input',function(){
      formData[templateId][fieldId+'_list'][idx]=inp.value;
      updatePreview(templateId);updateProgress(templateId);autoSave();
    });})(i);
    item.appendChild(num);item.appendChild(inp);container.appendChild(item);
  });
}

/* â”€â”€ PROGRESS â”€â”€ */
function updateProgress(templateId){
  var tpl=TEMPLATES[templateId],total=tpl.fields.length,filled=0;
  tpl.fields.forEach(function(f){
    var val=f.type==='questions'?(formData[templateId][f.id+'_list']||[]).filter(function(q){return q&&q.trim();}).length:(formData[templateId][f.id]||'').trim().length;
    if(val>0) filled++;
  });
  var pct=Math.round((filled/total)*100);
  document.getElementById('progressFill').style.width=pct+'%';
  document.getElementById('progressPct').textContent=pct+'%';
  updateQualityCheck(templateId,pct);
}

/* â”€â”€ QUALITY CHECK â”€â”€ */
function updateQualityCheck(templateId,pct){
  var wrap=document.getElementById('qualityWrap');
  if(!wrap) return;
  wrap.style.display='block';
  var tpl=TEMPLATES[templateId];
  var issues=[];
  tpl.fields.forEach(function(f){
    var val=f.type==='questions'?(formData[templateId][f.id+'_list']||[]).filter(function(q){return q&&q.trim();}).join(' '):(formData[templateId][f.id]||'');
    var info=f[lang]||f['ar'];
    if(!val.trim()){issues.push({label:info.label,status:'bad'});}
    else if(WORD_LIMITS[f.id]>0){
      var wc=val.trim().split(/\s+/).length;
      if(wc<WORD_LIMITS[f.id]*0.4) issues.push({label:info.label,status:'warn'});
      else issues.push({label:info.label,status:'ok'});
    } else {issues.push({label:info.label,status:'ok'});}
  });
  var cls=pct<40?'low':pct<75?'mid':'high';
  var emoji=pct<40?'ğŸ”´':pct<75?'ğŸŸ¡':'ğŸŸ¢';
  var html='<div style="padding:.4rem">'
    +'<div style="font-size:.68rem;color:var(--muted);font-family:IBM Plex Mono,monospace;margin-bottom:.4rem">'+T[lang].qualityTitle+'</div>'
    +'<div class="quality-score '+cls+'">'+pct+'%</div>'
    +'<div style="display:flex;flex-direction:column;gap:.3rem;margin-top:.5rem">';
  issues.forEach(function(it){
    html+='<div style="display:flex;align-items:center;gap:.4rem;font-size:.7rem;color:#9a9082">'
      +'<div style="width:7px;height:7px;border-radius:50%;flex-shrink:0;background:'+(it.status==='ok'?'#27ae60':it.status==='warn'?'#e67e22':'#c0392b')+'"></div>'
      +escHtml(it.label)+'</div>';
  });
  html+='</div></div>';
  wrap.innerHTML=html;
}

/* â”€â”€ PREVIEW â”€â”€ */
function updatePreview(templateId){
  var tpl=TEMPLATES[templateId];
  var style=document.getElementById('styleSelect').value;
  document.getElementById('styleTag').textContent=style;
  var el=document.getElementById('previewEmpty');if(el) el.style.display='none';
  var info=tpl[lang]||tpl['ar'];
  var data=formData[templateId]||{};
  var uniName=lang==='ar'?'Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø¨Ø§Ø­Ø« Ø§Ù„Ø¹Ù„Ù…ÙŠØ©':'Academic Research University';
  var html='<div class="doc-uni-header"><div class="doc-uni-name">'+escHtml(uniName)+'</div>'
    +'<div class="doc-doc-type">'+escHtml(info.title)+'</div>'
    +'<div class="doc-style-tag">'+style+' Format | '+new Date().getFullYear()+'</div></div>';
  tpl.fields.forEach(function(f){
    var finfo=f[lang]||f['ar'];
    var val='';
    if(f.type==='questions'){var list=data[f.id+'_list']||[];val=list.filter(function(q){return q&&q.trim();}).map(function(q,i){return(i+1)+'. '+q;}).join('\n');}
    else{val=data[f.id]||'';}
    var bodyHTML=val.trim()?'<div class="doc-section-body">'+escHtml(val)+'</div>':'<div class="doc-placeholder">'+T[lang].notEntered+'</div>';
    html+='<div class="doc-section"><div class="doc-section-title">'+escHtml(finfo.label)+'</div>'+bodyHTML+'</div>';
  });
  document.getElementById('previewDoc').innerHTML=html;
}

function onStyleChange(){
  document.getElementById('styleTag').textContent=document.getElementById('styleSelect').value;
  if(currentTemplate) updatePreview(currentTemplate);
}

/* â”€â”€ HINT â”€â”€ */
function toggleHint(id){var el=document.getElementById(id);if(el) el.classList.toggle('visible');}

/* â”€â”€ AUTOSAVE (localStorage) â”€â”€ */
var autoSaveTimer;
function autoSave(){
  clearTimeout(autoSaveTimer);
  autoSaveTimer=setTimeout(function(){
    if(!currentTemplate) return;
    try{
      var state={template:currentTemplate,lang:lang,data:formData};
      localStorage.setItem('fajr_autosave',JSON.stringify(state));
    }catch(e){}
  },800);
}

function loadAutoSave(){
  try{
    var raw=localStorage.getItem('fajr_autosave');
    if(!raw) return;
    var state=JSON.parse(raw);
    if(state.data) formData=state.data;
    if(state.lang) lang=state.lang;
    if(state.template){
      setTimeout(function(){selectTemplate(state.template);},200);
    }
  }catch(e){}
}

/* â”€â”€ DRAFTS â”€â”€ */
function openSaveModal(){
  if(!currentTemplate){showToast(lang==='ar'?'Ø§Ø®ØªØ± Ù‚Ø§Ù„Ø¨Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹':'Please select a template first');return;}
  document.getElementById('saveModal').classList.add('open');
  document.getElementById('draftNameInput').focus();
}
function closeModal(){document.getElementById('saveModal').classList.remove('open');}

function saveDraft(){
  var name=document.getElementById('draftNameInput').value.trim();
  if(!name){showToast(lang==='ar'?'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ø§Ù‹ Ù„Ù„Ù…Ø³ÙˆØ¯Ø©':'Please enter a draft name');return;}
  try{
    var drafts=getDrafts();
    var id='draft_'+Date.now();
    drafts[id]={name:name,template:currentTemplate,lang:lang,data:JSON.parse(JSON.stringify(formData)),date:new Date().toLocaleDateString('ar-SA')};
    localStorage.setItem('fajr_drafts',JSON.stringify(drafts));
    closeModal();
    document.getElementById('draftNameInput').value='';
    renderDraftsList();
    showToast(T[lang].toastSaved);
  }catch(e){showToast(lang==='ar'?'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸':'Save error');}
}

function getDrafts(){
  try{return JSON.parse(localStorage.getItem('fajr_drafts')||'{}');}catch(e){return{};}
}

function loadDraft(id){
  var drafts=getDrafts();
  var d=drafts[id];
  if(!d) return;
  formData=JSON.parse(JSON.stringify(d.data));
  if(d.lang) lang=d.lang;
  if(d.template) selectTemplate(d.template);
  showToast(T[lang].toastLoaded);
}

function deleteDraft(id,e){
  e.stopPropagation();
  var drafts=getDrafts();
  delete drafts[id];
  localStorage.setItem('fajr_drafts',JSON.stringify(drafts));
  renderDraftsList();
  showToast(T[lang].toastDeleted);
}

function renderDraftsList(){
  var list=document.getElementById('draftsList');
  if(!list) return;
  var drafts=getDrafts();
  var keys=Object.keys(drafts);
  if(keys.length===0){list.innerHTML='<div class="no-drafts">'+T[lang].noDrafts+'</div>';return;}
  list.innerHTML='';
  keys.reverse().forEach(function(id){
    var d=drafts[id];
    var item=document.createElement('div');item.className='draft-item';
    item.innerHTML='<div><div class="draft-name">'+escHtml(d.name)+'</div><div class="draft-date">'+escHtml(d.date||'')+'</div></div>'
      +'<button class="draft-del" title="Ø­Ø°Ù">âœ•</button>';
    item.querySelector('.draft-del').addEventListener('click',function(e){deleteDraft(id,e);});
    item.addEventListener('click',function(){loadDraft(id);});
    list.appendChild(item);
  });
}

/* â”€â”€ EXPORT JSON â”€â”€ */
function exportJSON(){
  if(!currentTemplate){showToast(lang==='ar'?'Ø§Ø®ØªØ± Ù‚Ø§Ù„Ø¨Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹':'Please select a template first');return;}
  var state={template:currentTemplate,lang:lang,data:formData,exportDate:new Date().toISOString()};
  var blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  var url=URL.createObjectURL(blob);
  var a=document.createElement('a');a.href=url;a.download='fajr_draft.json';
  document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
  showToast(T[lang].toastSaved);
}

function importJSON(event){
  var file=event.target.files[0];
  if(!file) return;
  var reader=new FileReader();
  reader.onload=function(e){
    try{
      var state=JSON.parse(e.target.result);
      if(state.data) formData=state.data;
      if(state.lang) lang=state.lang;
      if(state.template) selectTemplate(state.template);
      showToast(T[lang].toastLoaded);
    }catch(err){showToast(lang==='ar'?'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù':'Error loading file');}
  };
  reader.readAsText(file);
  event.target.value='';
}

/* â”€â”€ EXPORT WORD / PDF â”€â”€ */
function buildDocContent(){
  if(!currentTemplate) return null;
  var tpl=TEMPLATES[currentTemplate],info=tpl[lang]||tpl['ar'],data=formData[currentTemplate]||{};
  var style=document.getElementById('styleSelect').value;
  var uniName=lang==='ar'?'Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø¨Ø§Ø­Ø« Ø§Ù„Ø¹Ù„Ù…ÙŠØ©':'Academic Research University';
  var dir=lang==='ar'?'rtl':'ltr',align=lang==='ar'?'right':'left';
  var sections=[];
  tpl.fields.forEach(function(f){
    var finfo=f[lang]||f['ar'];var val='';
    if(f.type==='questions'){var list=data[f.id+'_list']||[];val=list.filter(function(q){return q&&q.trim();}).map(function(q,i){return(i+1)+'. '+q;}).join('\n');}
    else{val=data[f.id]||'';}
    sections.push({label:finfo.label,value:val});
  });
  return{title:info.title,uniName:uniName,style:style,dir:dir,align:align,sections:sections};
}

function exportDoc(){
  var d=buildDocContent();
  if(!d){showToast(lang==='ar'?'Ø§Ø®ØªØ± Ù‚Ø§Ù„Ø¨Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹':'Select a template first');return;}
  var rowsHTML=d.sections.map(function(s){
    var val=s.value.trim()||(lang==='ar'?'Ù„Ù… ÙŠÙØ¯Ø®ÙÙ„ Ø¨Ø¹Ø¯':'Not yet entered');
    var valHTML=val.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
    return '<h2 style="font-size:13pt;color:#0f0e0d;border-bottom:1px solid #ccc;padding-bottom:4pt;margin-top:18pt;">'+s.label.replace(/&/g,'&amp;')+'</h2>'
      +'<p style="font-size:12pt;line-height:1.8;color:#333;margin-top:6pt;">'+valHTML+'</p>';
  }).join('');
  var html='<!DOCTYPE html><html><head><meta charset="UTF-8"><style>body{font-family:Times New Roman,serif;direction:'+d.dir+';text-align:'+d.align+';margin:2.5cm;line-height:1.8}.header{text-align:center;border-bottom:2pt solid #000;padding-bottom:12pt;margin-bottom:24pt}</style></head><body>'
    +'<div class="header"><div style="font-size:11pt;font-weight:bold;">'+d.uniName+'</div>'
    +'<h1 style="font-size:16pt;">'+d.title+'</h1>'
    +'<div style="font-size:9pt;color:#888;">'+d.style+' Format | '+new Date().getFullYear()+'</div></div>'
    +rowsHTML+'</body></html>';
  var blob=new Blob(['\ufeff'+html],{type:'application/msword;charset=utf-8'});
  var url=URL.createObjectURL(blob);
  var a=document.createElement('a');a.href=url;a.download=(currentTemplate||'research')+'_fajr.doc';
  document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
  showToast(T[lang].toastWord);
}

function exportPDF(){
  var d=buildDocContent();
  if(!d){showToast(lang==='ar'?'Ø§Ø®ØªØ± Ù‚Ø§Ù„Ø¨Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹':'Select a template first');return;}
  var rowsHTML=d.sections.map(function(s){
    var val=s.value.trim()||(lang==='ar'?'Ù„Ù… ÙŠÙØ¯Ø®ÙÙ„ Ø¨Ø¹Ø¯':'Not yet entered');
    var valHTML=val.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
    return '<div style="margin-bottom:18pt;"><div style="font-size:11pt;font-weight:bold;border-bottom:1px solid #ccc;padding-bottom:4pt;margin-bottom:8pt;">'+s.label.replace(/&/g,'&amp;')+'</div>'
      +'<div style="font-size:11pt;line-height:1.9;color:#333;">'+valHTML+'</div></div>';
  }).join('');
  var html='<!DOCTYPE html><html><head><meta charset="UTF-8"><title>'+d.title+'</title></head>'
    +'<body style="font-family:Georgia,serif;direction:'+d.dir+';text-align:'+d.align+';margin:0;padding:2cm;">'
    +'<div style="text-align:center;border-bottom:2pt solid #000;padding-bottom:14pt;margin-bottom:28pt;">'
    +'<div style="font-weight:bold;">'+d.uniName+'</div>'
    +'<div style="font-size:15pt;font-weight:bold;margin-top:6pt;">'+d.title+'</div>'
    +'<div style="font-size:9pt;color:#888;margin-top:4pt;">'+d.style+' | '+new Date().getFullYear()+'</div></div>'
    +rowsHTML+'<script>window.onload=function(){window.print();}<\/script></body></html>';
  var w=window.open('','_blank');
  if(w){w.document.write(html);w.document.close();showToast(T[lang].toastPdf);}
  else{showToast(lang==='ar'?'Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©':'Allow pop-ups');}
}

/* â”€â”€ UTILS â”€â”€ */
function showToast(msg){
  var t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');
  setTimeout(function(){t.classList.remove('show');},3000);
}
function escHtml(s){if(!s) return '';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function escAttr(s){if(!s) return '';return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

/* â”€â”€ MODAL KEYBOARD â”€â”€ */
document.getElementById('saveModal').addEventListener('click',function(e){if(e.target===this) closeModal();});
document.getElementById('draftNameInput').addEventListener('keydown',function(e){if(e.key==='Enter') saveDraft();});

/* â”€â”€ INIT â”€â”€ */
renderDraftsList();
loadAutoSave();
if(!currentTemplate) setTimeout(function(){selectTemplate('proposal');},100);
</script>
</body>
</html>
